# Структура для виртуальной машины

Эта директория содержит файлы для развертывания приложения на сервере.

## Структура

```
vm/
├── data/             # База данных (НЕ в Git)
├── backups/          # Бэкапы приложения (НЕ в Git)
├── scripts/
│   └── update.sh     # Скрипт обновления с бэкапом
├── docker-compose.yml # Docker Compose для ВМ
└── README.md         # Этот файл
```

**Примечание:** Код приложения находится в `../app/` (из корня репозитория), не копируется в `vm/`.

## Первоначальная настройка (первый раз)

1. **Клонирование репозитория:**
```bash
cd ~
mkdir -p support-helper
cd support-helper
git clone https://github.com/your-username/support-helper.git support-helper
cd support-helper
```

2. **Создание структуры на сервере:**
```bash
# Создаем директории для данных и бэкапов
mkdir -p vm/data vm/backups
chmod 777 vm/data
```

3. **Запуск приложения:**
```bash
cd vm
docker compose up -d --build

# Ждем несколько секунд для запуска контейнеров
sleep 5

# Инициализация БД (добавление тестовых данных)
docker exec -it support-helper-python python3 init_db.py
```

4. **Проверка работы:**
```bash
# Проверка статуса контейнеров
docker compose ps

# Просмотр логов
docker compose logs -f

# Приложение доступно по адресу: http://ваш-ip:8080
```

## Настройка Git для работы скрипта обновления

Git уже настроен после клонирования репозитория. Скрипт обновления работает с `app/` из корня репозитория, дополнительная настройка не требуется.

## Обновление приложения

После настройки Git используйте скрипт обновления:

```bash
cd vm
chmod +x scripts/update.sh
./scripts/update.sh
```

Скрипт автоматически:
1. Создает бэкап кода и БД
2. Обновляет код из Git
3. Перезапускает контейнеры
4. Проверяет и инициализирует БД если нужно
5. Очищает старые бэкапы (оставляет последние 10)

## Восстановление из бэкапа

```bash
# Найти нужный бэкап
ls -la backups/

# Восстановить код (из корня репозитория)
cd ../..
cp -r vm/backups/backup-YYYYMMDD-HHMMSS/app/* app/

# Восстановить БД
cp vm/backups/backup-YYYYMMDD-HHMMSS/data/support-helper.db vm/data/

# Перезапустить
cd vm
docker compose restart
```

## Важно

- Директории `data/` и `backups/` НЕ должны попадать в Git
- Код приложения находится в `app/` и синхронизируется с GitHub
- Бэкапы создаются автоматически перед каждым обновлением

