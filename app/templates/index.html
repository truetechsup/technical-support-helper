<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫</h1>
            <p class="subtitle">Technical Support Helper</p>
            <nav class="main-nav">
                <a href="/" class="active">üîç –ü–æ–∏—Å–∫</a>
                <a href="/add">‚ûï –î–æ–±–∞–≤–∏—Ç—å</a>
            </nav>
        </header>

        <main>
            <div class="search-section">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ –µ–≥–æ —á–∞—Å—Ç—å..."
                        autocomplete="off"
                    >
                    <button id="searchButton">–ü–æ–∏—Å–∫</button>
                </div>
                <div id="loading" class="loading" style="display: none;">
                    –ü–æ–∏—Å–∫...
                </div>
            </div>

            <div id="results" class="results"></div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
            </div>
            <div class="modal-body">
                <p>–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—à–∏–±–∫—É?</p>
                <p class="modal-warning">‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å!</p>
                <div class="modal-error-preview" id="modalErrorPreview"></div>
            </div>
            <div class="modal-footer">
                <button id="confirmDelete" class="btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button id="cancelDelete" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
        searchButton.addEventListener('click', performSearch);

        function performSearch() {
            const query = searchInput.value.trim();
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="no-results">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞</div>';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            // AJAX –∑–∞–ø—Ä–æ—Å
            fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                    return;
                }

                const results = data.results || [];
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                let html = `<div class="results-count">–ù–∞–π–¥–µ–Ω–æ: ${results.length}</div>`;
                
                results.forEach(result => {
                    html += `
                        <div class="error-card" data-uuid="${escapeHtml(result.uuid)}">
                            <div class="error-header">
                                <h3>${escapeHtml(result.error)}</h3>
                                <button class="btn-delete" data-uuid="${escapeHtml(result.uuid)}" data-error="${escapeHtml(result.error)}" title="–£–¥–∞–ª–∏—Ç—å">
                                    üóëÔ∏è
                                </button>
                            </div>
                            
                            ${result.description ? `
                                <div class="error-section">
                                    <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                                    <p>${escapeHtml(result.description)}</p>
                                </div>
                            ` : ''}
                            
                            ${result.solution ? `
                                <div class="error-section">
                                    <strong>–†–µ—à–µ–Ω–∏–µ:</strong>
                                    <p>${escapeHtml(result.solution)}</p>
                                </div>
                            ` : ''}
                            
                            ${result.tickets && result.tickets.length > 0 ? `
                                <div class="error-section">
                                    <strong>–ù–æ–º–µ—Ä–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π:</strong>
                                    <ul class="ticket-list">
                                        ${result.tickets.map(ticket => `<li>${escapeHtml(ticket)}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${result.tasks && result.tasks.length > 0 ? `
                                <div class="error-section">
                                    <strong>–ó–∞–¥–∞—á–∏:</strong>
                                    <ul class="task-list">
                                        ${result.tasks.map(task => `<li><a href="${escapeHtml(task)}" target="_blank">${escapeHtml(task)}</a></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
                resultsDiv.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const uuid = this.getAttribute('data-uuid');
                        const errorText = this.getAttribute('data-error');
                        showDeleteModal(uuid, errorText);
                    });
                });
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}</div>`;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è
        let deleteUuid = null;

        function showDeleteModal(uuid, errorText) {
            deleteUuid = uuid;
            const modal = document.getElementById('deleteModal');
            const preview = document.getElementById('modalErrorPreview');
            
            preview.textContent = errorText;
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            
            // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        function hideDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.style.opacity = '0';
            
            // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å–∫—Ä—ã—Ç–∏–µ–º
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            
            deleteUuid = null;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const modal = document.getElementById('deleteModal');
        const cancelBtn = document.getElementById('cancelDelete');
        
        cancelBtn.addEventListener('click', hideDeleteModal);
        
        modal.addEventListener('click', function(e) {
            if (e.target === this || e.target.closest('.modal-content') === null) {
                hideDeleteModal();
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                hideDeleteModal();
            }
        });

        document.getElementById('confirmDelete').addEventListener('click', async function() {
            if (!deleteUuid) return;

            const button = this;
            button.disabled = true;
            button.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ uuid: deleteUuid })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ DOM
                    const card = document.querySelector(`[data-uuid="${deleteUuid}"]`);
                    if (card) {
                        card.style.animation = 'fadeOut 0.3s';
                        setTimeout(() => card.remove(), 300);
                    }
                    hideDeleteModal();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    const message = document.createElement('div');
                    message.className = 'success-message';
                    message.textContent = '‚úÖ –û—à–∏–±–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞';
                    resultsDiv.insertBefore(message, resultsDiv.firstChild);
                    setTimeout(() => message.remove(), 3000);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ—à–∏–±–∫—É'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = '–î–∞, —É–¥–∞–ª–∏—Ç—å';
            }
        });
    </script>
</body>
</html>

