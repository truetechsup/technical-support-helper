<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –ø–æ –æ—à–∏–±–∫–∞–º - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç –ü–æ–∏—Å–∫ </h1>
            <p class="subtitle">Technical Support Helper</p>
            <nav class="main-nav">
                <a href="/" class="active">üîç –ü–æ–∏—Å–∫</a>
                <a href="/add">‚ûï –î–æ–±–∞–≤–∏—Ç—å</a>
            </nav>
        </header>

        <main>
            <div class="search-section">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –æ—à–∏–±–∫–∏..."
                        autocomplete="off"
                    >
                    <button id="searchButton">–ü–æ–∏—Å–∫</button>
                </div>
                <div id="loading" class="loading" style="display: none;">
                    –ü–æ–∏—Å–∫...
                </div>
            </div>

            <div id="results" class="results"></div>
        </main>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        
        let allErrors = []; // –•—Ä–∞–Ω–∏–º –≤—Å–µ –æ—à–∏–±–∫–∏

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            loadAllErrors();
        });

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
        searchInput.addEventListener('input', function() {
            filterErrors();
        });

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterErrors();
            }
        });

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
        searchButton.addEventListener('click', filterErrors);

        function loadAllErrors() {
            loadingDiv.style.display = 'block';
            
            fetch('/api/all')
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    
                    if (data.error) {
                        resultsDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                        return;
                    }

                    allErrors = data.results || [];
                    displayErrors(allErrors);
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    resultsDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}</div>`;
                });
        }

        function filterErrors() {
            const query = searchInput.value.trim().toLowerCase();
            
            if (!query) {
                displayErrors(allErrors);
                return;
            }

            const filtered = allErrors.filter(error => 
                error.error.toLowerCase().includes(query)
            );
            
            displayErrors(filtered);
        }

        function displayErrors(results) {
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            let html = `<div class="results-count">–ù–∞–π–¥–µ–Ω–æ: ${results.length}</div>`;
            
            results.forEach(result => {
                html += `
                    <div class="error-card" data-uuid="${escapeHtml(result.uuid)}">
                        <div class="error-header">
                            <h3>${escapeHtml(result.error)}</h3>
                            <button class="btn-delete" data-uuid="${escapeHtml(result.uuid)}" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                        </div>
                        
                        ${result.description ? `
                            <div class="error-section">
                                <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                                <p>${escapeHtml(result.description)}</p>
                            </div>
                        ` : ''}
                        
                        ${result.solution ? `
                            <div class="error-section">
                                <strong>–†–µ—à–µ–Ω–∏–µ:</strong>
                                <p>${escapeHtml(result.solution)}</p>
                            </div>
                        ` : ''}
                        
                        ${result.tickets && result.tickets.length > 0 ? `
                            <div class="error-section">
                                <strong>–ù–æ–º–µ—Ä–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π:</strong>
                                <ul class="ticket-list">
                                    ${result.tickets.map(ticket => `<li>${escapeHtml(ticket)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${result.tasks && result.tasks.length > 0 ? `
                            <div class="error-section">
                                <strong>–ó–∞–¥–∞—á–∏:</strong>
                                <ul class="task-list">
                                    ${result.tasks.map(task => `<li><a href="${escapeHtml(task)}" target="_blank">${escapeHtml(task)}</a></li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
            resultsDiv.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const uuid = this.getAttribute('data-uuid');
                    deleteError(uuid);
                });
            });
        }

        async function deleteError(uuid) {
            if (!uuid) return;

            const button = document.querySelector(`.btn-delete[data-uuid="${uuid}"]`);
            if (button) {
                button.disabled = true;
                button.textContent = '...';
            }

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ uuid: uuid })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
                    allErrors = allErrors.filter(error => error.uuid !== uuid);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    filterErrors();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    const message = document.createElement('div');
                    message.className = 'success-message';
                    message.textContent = '‚úÖ –û—à–∏–±–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞';
                    resultsDiv.insertBefore(message, resultsDiv.firstChild);
                    setTimeout(() => message.remove(), 3000);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ—à–∏–±–∫—É'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üóëÔ∏è';
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

